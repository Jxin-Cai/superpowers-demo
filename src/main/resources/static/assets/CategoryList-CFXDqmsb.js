import{_ as B,h as p,a as N,c as R,i as s,w as i,b as C,t as q,s as E,l as b,E as u,v as $,f,g as G}from"./index-C9hZSNhL.js";import{c as v}from"./category-DBE6783O.js";import"./index-61r5FlMj.js";const H={class:"category-tree"},K={class:"tree-node"},Q={class:"node-label"},W={class:"node-actions"},X={__name:"CategoryTree",emits:["refresh"],setup(S,{expose:x,emit:k}){const h=k,y=f(),c=f([]),m=f(!1),V=f(!1),g=f(null),U={label:"name",children:"children"},o=f({name:"",description:"",parentId:null,sortOrder:0}),A=G(()=>{const t=new Set,e=a=>{t.add(a.id),a.children&&a.children.forEach(e)};if(g.value){const a=r=>{for(const n of r){if(n.id===g.value)return e(n),!0;if(n.children&&a(n.children))return!0}return!1};a(c.value)}const l=a=>a.filter(r=>!t.has(r.id)).map(r=>({...r,children:r.children?l(r.children):void 0}));return l(JSON.parse(JSON.stringify(c.value)))}),w=async()=>{try{const t=await v.getTree();c.value=D(t.data.tree||[])}catch(t){console.error("加载分类树失败:",t),u.error("加载分类树失败")}},D=t=>t.map(e=>{const l={...e};return l.children&&l.children.length>0?l.children=D(l.children):delete l.children,l}),M=(t,e,l)=>{if(l==="inner"){const a=(r,n)=>r.id===n?!0:r.children?r.children.some(_=>a(_,n)):!1;return!a(t,e.id)}return!0},z=async(t,e,l)=>{var a,r;try{if(l==="inner")await v.moveToCategory(t.data.id,e.data.id),u.success("移动成功");else{const _=e.parent.childNodes.map((I,O)=>({id:I.data.id,sortOrder:O}));await v.reorder(_),u.success("排序成功")}await w(),h("refresh")}catch(n){u.error(((r=(a=n.response)==null?void 0:a.data)==null?void 0:r.message)||"操作失败"),await w()}},J=t=>{V.value=!0,g.value=t.id,o.value={name:t.name,description:t.description||"",parentId:t.parentId,sortOrder:t.sortOrder||0},m.value=!0},L=async t=>{var l,a;const e=t.children&&t.children.length>0;try{let r="确定删除该分类吗？",n=!1;e?n=await $.confirm(`该分类包含 ${t.children.length} 个子分类，是否同时删除？`,"确认删除",{distinguishCancelAndClose:!0,confirmButtonText:"全部删除",cancelButtonText:"仅删除当前",type:"warning"})==="confirm":await $.confirm(r,"确认删除",{type:"warning"}),await v.delete(t.id,n),u.success("删除成功"),await w(),h("refresh")}catch(r){r!=="cancel"&&r!=="close"&&u.error(((a=(l=r.response)==null?void 0:l.data)==null?void 0:a.message)||"删除失败")}},F=async()=>{var t,e;try{const l={name:o.value.name,description:o.value.description,parentId:o.value.parentId||null,sortOrder:o.value.sortOrder};V.value?(await v.update(g.value,l),u.success("更新成功")):(await v.create(l),u.success("创建成功")),m.value=!1,await w(),h("refresh")}catch(l){u.error(((e=(t=l.response)==null?void 0:t.data)==null?void 0:e.message)||"保存失败")}};return x({load:w,create:()=>{V.value=!1,g.value=null,o.value={name:"",description:"",parentId:null,sortOrder:0},m.value=!0}}),(t,e)=>{const l=p("el-button"),a=p("el-tree"),r=p("el-input"),n=p("el-form-item"),_=p("el-tree-select"),I=p("el-input-number"),O=p("el-form"),P=p("el-dialog");return N(),R("div",H,[s(a,{ref_key:"treeRef",ref:y,data:c.value,props:U,draggable:"","node-key":"id","default-expand-all":"","allow-drop":M,onNodeDrop:z},{default:i(({node:d,data:T})=>[C("div",K,[C("span",Q,q(d.label),1),C("span",W,[s(l,{size:"small",text:"",type:"primary",onClick:E(j=>J(T),["stop"])},{default:i(()=>[...e[6]||(e[6]=[b(" 编辑 ",-1)])]),_:1},8,["onClick"]),s(l,{size:"small",text:"",type:"danger",onClick:E(j=>L(T),["stop"])},{default:i(()=>[...e[7]||(e[7]=[b(" 删除 ",-1)])]),_:1},8,["onClick"])])])]),_:1},8,["data"]),s(P,{modelValue:m.value,"onUpdate:modelValue":e[5]||(e[5]=d=>m.value=d),title:V.value?"编辑分类":"新建分类",width:"500px"},{footer:i(()=>[s(l,{onClick:e[4]||(e[4]=d=>m.value=!1)},{default:i(()=>[...e[8]||(e[8]=[b("取消",-1)])]),_:1}),s(l,{type:"primary",onClick:F},{default:i(()=>[...e[9]||(e[9]=[b("保存",-1)])]),_:1})]),default:i(()=>[s(O,{model:o.value,"label-width":"100px"},{default:i(()=>[s(n,{label:"分类名称"},{default:i(()=>[s(r,{modelValue:o.value.name,"onUpdate:modelValue":e[0]||(e[0]=d=>o.value.name=d),placeholder:"请输入分类名称"},null,8,["modelValue"])]),_:1}),s(n,{label:"描述"},{default:i(()=>[s(r,{modelValue:o.value.description,"onUpdate:modelValue":e[1]||(e[1]=d=>o.value.description=d),type:"textarea",rows:3,placeholder:"请输入描述"},null,8,["modelValue"])]),_:1}),s(n,{label:"父分类"},{default:i(()=>[s(_,{modelValue:o.value.parentId,"onUpdate:modelValue":e[2]||(e[2]=d=>o.value.parentId=d),data:A.value,props:{label:"name",value:"id",children:"children"},placeholder:"请选择父分类",clearable:"","check-strictly":"","render-after-expand":!1},null,8,["modelValue","data"])]),_:1}),s(n,{label:"排序序号"},{default:i(()=>[s(I,{modelValue:o.value.sortOrder,"onUpdate:modelValue":e[3]||(e[3]=d=>o.value.sortOrder=d),min:0,max:9999},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Y=B(X,[["__scopeId","data-v-f7af813a"]]),Z={class:"category-list"},ee={class:"header"},te={__name:"CategoryList",setup(S){const x=f(),k=()=>{var y;(y=x.value)==null||y.create()},h=()=>{};return(y,c)=>{const m=p("el-button");return N(),R("div",Z,[C("div",ee,[c[1]||(c[1]=C("h2",null,"分类管理",-1)),s(m,{type:"primary",onClick:k},{default:i(()=>[...c[0]||(c[0]=[b(" 新建分类 ",-1)])]),_:1})]),s(Y,{ref_key:"treeRef",ref:x,onRefresh:h},null,512)])}}},se=B(te,[["__scopeId","data-v-470f13ca"]]);export{se as default};
