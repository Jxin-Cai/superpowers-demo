import{_ as $,h as f,a as B,c as N,i as s,w as i,b as C,t as q,s as T,l as w,E as p,v as D,f as _,g as G}from"./index-CqkaHcZk.js";import{c as v}from"./category-C0wM35B6.js";import"./index-BuRDC5Sn.js";const H={class:"category-tree"},K={class:"tree-node"},Q={class:"node-label"},W={class:"node-actions"},X={__name:"CategoryTree",emits:["refresh"],setup(R,{expose:x,emit:I}){const h=I,g=_(),c=_([]),m=_(!1),V=_(!1),y=_(null),S={label:"name",children:"children"},o=_({name:"",description:"",parentId:null,sortOrder:0}),U=G(()=>{const r=new Set,e=n=>{r.add(n.id),n.children&&n.children.forEach(e)};if(y.value){const n=t=>{for(const l of t){if(l.id===y.value)return e(l),!0;if(l.children&&n(l.children))return!0}return!1};n(c.value)}const a=n=>n.filter(t=>!r.has(t.id)).map(t=>({...t,children:t.children?a(t.children):void 0}));return a(JSON.parse(JSON.stringify(c.value)))}),b=async()=>{try{const r=await v.getTree();c.value=M(r.data)}catch{p.error("加载分类树失败")}},M=r=>{const e=new Map,a=[];r.forEach(t=>{e.set(t.id,{...t,children:[]})}),r.forEach(t=>{const l=e.get(t.id);if(t.parentId===null||t.parentId===void 0)a.push(l);else{const u=e.get(t.parentId);u?u.children.push(l):a.push(l)}});const n=t=>{t.forEach(l=>{l.children&&l.children.length===0?delete l.children:l.children&&n(l.children)})};return n(a),a},A=(r,e,a)=>{if(a==="inner"){const n=(t,l)=>t.id===l?!0:t.children?t.children.some(u=>n(u,l)):!1;return!n(r,e.id)}return!0},z=async(r,e,a)=>{var n,t;try{if(a==="inner")await v.moveToCategory(r.data.id,e.data.id),p.success("移动成功");else{const u=e.parent.childNodes.map((k,O)=>({id:k.data.id,sortOrder:O}));await v.reorder(u),p.success("排序成功")}await b(),h("refresh")}catch(l){p.error(((t=(n=l.response)==null?void 0:n.data)==null?void 0:t.message)||"操作失败"),await b()}},J=r=>{V.value=!0,y.value=r.id,o.value={name:r.name,description:r.description||"",parentId:r.parentId,sortOrder:r.sortOrder||0},m.value=!0},L=async r=>{var a,n;const e=r.children&&r.children.length>0;try{let t="确定删除该分类吗？",l=!1;e?l=await D.confirm(`该分类包含 ${r.children.length} 个子分类，是否同时删除？`,"确认删除",{distinguishCancelAndClose:!0,confirmButtonText:"全部删除",cancelButtonText:"仅删除当前",type:"warning"})==="confirm":await D.confirm(t,"确认删除",{type:"warning"}),await v.delete(r.id,l),p.success("删除成功"),await b(),h("refresh")}catch(t){t!=="cancel"&&t!=="close"&&p.error(((n=(a=t.response)==null?void 0:a.data)==null?void 0:n.message)||"删除失败")}},F=async()=>{var r,e;try{const a={name:o.value.name,description:o.value.description,parentId:o.value.parentId||null,sortOrder:o.value.sortOrder};V.value?(await v.update(y.value,a),p.success("更新成功")):(await v.create(a),p.success("创建成功")),m.value=!1,await b(),h("refresh")}catch(a){p.error(((e=(r=a.response)==null?void 0:r.data)==null?void 0:e.message)||"保存失败")}};return x({load:b,create:()=>{V.value=!1,y.value=null,o.value={name:"",description:"",parentId:null,sortOrder:0},m.value=!0}}),(r,e)=>{const a=f("el-button"),n=f("el-tree"),t=f("el-input"),l=f("el-form-item"),u=f("el-tree-select"),k=f("el-input-number"),O=f("el-form"),P=f("el-dialog");return B(),N("div",H,[s(n,{ref_key:"treeRef",ref:g,data:c.value,props:S,draggable:"","node-key":"id","default-expand-all":"","allow-drop":A,onNodeDrop:z},{default:i(({node:d,data:E})=>[C("div",K,[C("span",Q,q(d.label),1),C("span",W,[s(a,{size:"small",text:"",type:"primary",onClick:T(j=>J(E),["stop"])},{default:i(()=>[...e[6]||(e[6]=[w(" 编辑 ",-1)])]),_:1},8,["onClick"]),s(a,{size:"small",text:"",type:"danger",onClick:T(j=>L(E),["stop"])},{default:i(()=>[...e[7]||(e[7]=[w(" 删除 ",-1)])]),_:1},8,["onClick"])])])]),_:1},8,["data"]),s(P,{modelValue:m.value,"onUpdate:modelValue":e[5]||(e[5]=d=>m.value=d),title:V.value?"编辑分类":"新建分类",width:"500px"},{footer:i(()=>[s(a,{onClick:e[4]||(e[4]=d=>m.value=!1)},{default:i(()=>[...e[8]||(e[8]=[w("取消",-1)])]),_:1}),s(a,{type:"primary",onClick:F},{default:i(()=>[...e[9]||(e[9]=[w("保存",-1)])]),_:1})]),default:i(()=>[s(O,{model:o.value,"label-width":"100px"},{default:i(()=>[s(l,{label:"分类名称"},{default:i(()=>[s(t,{modelValue:o.value.name,"onUpdate:modelValue":e[0]||(e[0]=d=>o.value.name=d),placeholder:"请输入分类名称"},null,8,["modelValue"])]),_:1}),s(l,{label:"描述"},{default:i(()=>[s(t,{modelValue:o.value.description,"onUpdate:modelValue":e[1]||(e[1]=d=>o.value.description=d),type:"textarea",rows:3,placeholder:"请输入描述"},null,8,["modelValue"])]),_:1}),s(l,{label:"父分类"},{default:i(()=>[s(u,{modelValue:o.value.parentId,"onUpdate:modelValue":e[2]||(e[2]=d=>o.value.parentId=d),data:U.value,props:{label:"name",value:"id",children:"children"},placeholder:"请选择父分类",clearable:"","check-strictly":"","render-after-expand":!1},null,8,["modelValue","data"])]),_:1}),s(l,{label:"排序序号"},{default:i(()=>[s(k,{modelValue:o.value.sortOrder,"onUpdate:modelValue":e[3]||(e[3]=d=>o.value.sortOrder=d),min:0,max:9999},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Y=$(X,[["__scopeId","data-v-ce1b03eb"]]),Z={class:"category-list"},ee={class:"header"},te={__name:"CategoryList",setup(R){const x=_(),I=()=>{var g;(g=x.value)==null||g.create()},h=()=>{};return(g,c)=>{const m=f("el-button");return B(),N("div",Z,[C("div",ee,[c[1]||(c[1]=C("h2",null,"分类管理",-1)),s(m,{type:"primary",onClick:I},{default:i(()=>[...c[0]||(c[0]=[w(" 新建分类 ",-1)])]),_:1})]),s(Y,{ref_key:"treeRef",ref:x,onRefresh:h},null,512)])}}},se=$(te,[["__scopeId","data-v-470f13ca"]]);export{se as default};
